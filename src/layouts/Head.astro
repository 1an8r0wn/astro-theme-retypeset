---
import themeConfig from '@/config'
import { ClientRouter } from 'astro:transitions'

interface Props {
  postTitle?: string
  postDescription?: string
  postImage?: string
}

const { postTitle, postDescription, postImage } = Astro.props
const { title, subtitle, description, author, url, favicon } = themeConfig.site
const { light: { background: lightMode }, dark: { background: darkMode } } = themeConfig.color
const { locale, moreLocale } = themeConfig.global
const { verification = {}, twitterID = '', googleAnalyticsID = '', umamiAnalyticsID = '' } = themeConfig.seo ?? {}
const { google = '', bing = '', yandex = '', baidu = '' } = verification
const { commentURL = '', imageHostURL = '', customGoogleAnalyticsURL = '', customUmamiAnalyticsURL = '', customUmamiAnalyticsJS = '' } = themeConfig.preload
---

<head>
<!-- Basic info -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
{favicon.toLowerCase().endsWith('.webp') && <link rel="icon" type="image/webp" href={favicon} />}
{favicon.toLowerCase().endsWith('.svg') && <link rel="icon" type="image/svg+xml" href={favicon} />}
{favicon.toLowerCase().endsWith('.png') && <link rel="icon" type="image/png" href={favicon} />}
<title>{postTitle ? `${postTitle} | ${title}` : `${title} - ${subtitle}`}</title>
<meta name="description" content={postDescription || description} />
<meta name="author" content={author} />
<meta name="generator" content={Astro.generator} />
<meta name="theme-color" content={lightMode} />
<ClientRouter fallback="swap" />

<!-- Preload -->
{commentURL && <link rel="dns-prefetch" href={commentURL} />}
{imageHostURL && <link rel="dns-prefetch" href={imageHostURL} />}
{customGoogleAnalyticsURL && <link rel="dns-prefetch" href={customGoogleAnalyticsURL} />}
{customUmamiAnalyticsURL && <link rel="dns-prefetch" href={customUmamiAnalyticsURL} />}
<link rel="alternate" href="/rss.xml" type="application/rss+xml" title="RSS" />
<link rel="canonical" href={Astro.url} />

<!-- i18n hreflang generate -->
{[locale, ...moreLocale].map(lang => (
  <link
    rel="alternate"
    href={`${url}${lang === locale ? '' : lang}`}
    hreflang={lang === 'zh-tw' ? 'zh-TW' : lang}
  />
))}

<!-- Facebook Open Graph -->
<meta property="og:title" content={postTitle || title} />
<meta property="og:type" content={postTitle ? 'article' : 'website'} />
<meta property="og:image" content={postImage || favicon} />
<meta property="og:url" content={Astro.url} />
<meta property="og:description" content={postDescription || subtitle} />
<meta property="og:site_name" content={title} />

<!-- Twitter Card -->
<meta name="twitter:card" content="summary" />
<meta name="twitter:title" content={postTitle || title} />
<meta name="twitter:description" content={postDescription || subtitle} />
<meta name="twitter:image" content={postImage || favicon} />
{twitterID && (
  <>
    <meta name="twitter:site" content={twitterID} />
    <meta name="twitter:creator" content={twitterID} />
  </>
)}

<!-- Site Verification -->
{google && <meta name="google-site-verification" content={google} />}
{bing && <meta name="msvalidate.01" content={bing} />}
{yandex && <meta name="yandex-verification" content={yandex} />}
{baidu && <meta name="baidu-site-verification" content={baidu} />}

<!-- Theme Toggle -->
<script is:inline define:vars={{ defaultMode: themeConfig.color.mode, lightMode, darkMode }}>
function getCurrentTheme() {
  return document.documentElement.classList.contains('dark')
}

function updateMetaTheme(isDark) {
  const metaThemeColor = document.querySelector('meta[name="theme-color"]')
  if (metaThemeColor) {
    metaThemeColor.setAttribute('content', isDark ? darkMode : lightMode)
  }
}

function syncTheme() {
  const isDark = getCurrentTheme()
  updateMetaTheme(isDark)
}

function initTheme() {
  const theme = (() => {
    if (typeof localStorage !== 'undefined' && localStorage.getItem('theme')) {
      return localStorage.getItem('theme')
    }
    if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
      return 'dark'
    }
    return defaultMode
  })()

  const isDark = theme === 'dark'
  document.documentElement.classList.toggle('dark', isDark)
  updateMetaTheme(isDark)
}

initTheme()

window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
  if (!localStorage.getItem('theme')) {
    document.documentElement.classList.toggle('dark', e.matches)
    updateMetaTheme(e.matches)
  }
})

document.addEventListener('astro:before-swap', (event) => {
  const isDark = getCurrentTheme()
  event.newDocument.documentElement.classList.toggle('dark', isDark)
  const metaThemeColor = event.newDocument.querySelector('meta[name="theme-color"]')
  if (metaThemeColor) {
    metaThemeColor.setAttribute('content', isDark ? darkMode : lightMode)
  }
})

document.addEventListener('theme-changed', syncTheme)
document.addEventListener('astro:after-swap', syncTheme)
window.addEventListener('popstate', syncTheme)
window.addEventListener('pageshow', (event) => {
  if (event.persisted) {
    syncTheme()
  }
})
</script>

<!-- Google Analytics -->
{
  googleAnalyticsID && (
    <>
      <script
        type="text/partytown"
        crossorigin="anonymous"
        src={`${customGoogleAnalyticsURL || 'https://www.googletagmanager.com'}/gtag/js?id=${googleAnalyticsID}`}
      />
      <script
        type="text/partytown"
        define:vars={{ googleAnalyticsID, customGoogleAnalyticsURL }}
      >
        window.dataLayer = window.dataLayer || []
        function gtag(...args) {
          dataLayer.push(args)
        }
        gtag('js', new Date())
        if (customGoogleAnalyticsURL) {
          gtag('config', googleAnalyticsID, {
            transport_url: customGoogleAnalyticsURL,
          })
        }
        else {
          gtag('config', googleAnalyticsID)
        }
      </script>
    </>
  )
}

<!-- Umami Analytics -->
{
  umamiAnalyticsID && (
    <script
      type="text/partytown"
      crossorigin="anonymous"
      data-website-id={umamiAnalyticsID}
      src={customUmamiAnalyticsJS || 'https://analytics.umami.is/script.js'}
      data-cache="true"
    />
  )
}
</head>
