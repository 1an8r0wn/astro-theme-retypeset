---
import type { CollectionEntry } from 'astro:content'
import Comments from '@/components/Comments/index.astro'
import PostDate from '@/components/PostDate.astro'
import { allLocales, defaultLocale } from '@/config'
import Layout from '@/layouts/Layout.astro'
import { checkSlugDuplication } from '@/utils/content'
import { generateDescription } from '@/utils/description'
import { getCollection } from 'astro:content'

export async function getStaticPaths() {
  const posts = await getCollection('posts')

  const duplicates = await checkSlugDuplication(posts)
  if (duplicates.length > 0) {
    throw new Error(`Slug conflicts found:\n${duplicates.join('\n')}`)
  }

  // 创建slug到语言的映射
  const slugToLangs: Record<string, string[]> = {}

  // 填充映射
  posts.forEach((post: CollectionEntry<'posts'>) => {
    const slug = post.data.abbrlink || post.slug
    const lang = post.data.lang || defaultLocale

    // 如果文章没有指定语言，初始化为所有支持的语言
    if (!slugToLangs[slug]) {
      if (!post.data.lang) {
        slugToLangs[slug] = [...allLocales] // 文章支持所有语言
      }
      else {
        slugToLangs[slug] = [defaultLocale] // 仅默认语言和指定语言
      }
    }

    if (!slugToLangs[slug].includes(lang)) {
      slugToLangs[slug].push(lang)
    }
  })

  // 对每个文章的supportedLangs按照allLocales的顺序排序
  Object.keys(slugToLangs).forEach((slug) => {
    // 按照allLocales的顺序排序
    slugToLangs[slug].sort((a, b) => {
      return allLocales.indexOf(a) - allLocales.indexOf(b)
    })
  })

  // 定义路径数组的类型
  type PathItem = {
    params: { posts_slug: string }
    props: { post: any, lang: string, supportedLangs: string[] }
  }

  const paths: PathItem[] = []

  // 默认语言的文章页面 (没有语言前缀)
  posts.forEach((post: CollectionEntry<'posts'>) => {
    if (import.meta.env.DEV || !post.data.draft) {
      const slug = post.data.abbrlink || post.slug
      const postLang = post.data.lang || defaultLocale

      // 只有当文章语言是默认语言或没有指定语言时才生成默认语言路径
      if (postLang === defaultLocale || post.data.lang === '') {
        paths.push({
          params: { posts_slug: `posts/${slug}` },
          props: {
            post,
            lang: defaultLocale,
            supportedLangs: slugToLangs[slug] || [],
          },
        })
      }
    }
  })

  // 更多语言的文章页面 (有语言前缀)
  allLocales.forEach((lang: string) => {
    if (lang !== defaultLocale) {
      posts.forEach((post: CollectionEntry<'posts'>) => {
        if ((import.meta.env.DEV || !post.data.draft) && (post.data.lang === lang || post.data.lang === '')) {
          const slug = post.data.abbrlink || post.slug
          paths.push({
            params: { posts_slug: `${lang}/posts/${slug}` },
            props: {
              post,
              lang,
              supportedLangs: slugToLangs[slug] || [],
            },
          })
        }
      })
    }
  })

  return paths
}

const { post, lang, supportedLangs } = Astro.props
const description = generateDescription(post)
const { Content, remarkPluginFrontmatter } = await post.render()

// 构建标签链接
function getTagUrl(tagName: string): string {
  return lang === defaultLocale
    ? `/tags/${tagName}/`
    : `/${lang}/tags/${tagName}/`
}
---

<Layout
  postTitle={post.data.title}
  postDescription={description}
  postSlug={post.slug}
  supportedLangs={supportedLangs}
>

  <!-- Title -->
  <article class="heti mb-12.6">
    <h1 class="post-title">
      <span
        transition:name={`post-${post.data.abbrlink || post.slug}-${lang}`}
        data-disable-transition-on-theme
      >
        {post.data.title}
      </span>
    </h1>

    <!-- Date -->
    <div
      class="mb-16.8 block c-primary font-time"
      transition:name={`time-${post.data.abbrlink || post.slug}-${lang}`}
      data-disable-transition-on-theme
    >
      <PostDate
        date={post.data.published}
        updatedDate={post.data.updated}
        minutes={remarkPluginFrontmatter.minutes}
      />
    </div>
    <Content />
  </article>

  <!-- Tags -->
  {post.data.tags && post.data.tags.length > 0 && (
    <div class="uno-decorative-line"></div>
    <div class="uno-tags-wrapper">
      {post.data.tags.map((tag: string) => (
        <a
          href={getTagUrl(tag)}
          class="uno-tags-style"
        >
          {tag}
        </a>
      ))}
    </div>
  )}

  <Comments />
</Layout>
