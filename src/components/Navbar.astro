---
import themeConfig from '@/config'
import { ui } from '@/utils/ui'

const defaultLocale = themeConfig.global.locale
const moreLocales = themeConfig.global.moreLocale
const currentPath = Astro.url.pathname

const cleanPath = (path: string) => path.replace(/^\/+|\/+$/g, '')

function getLangFromPath(path: string) {
  const secondaryLang = moreLocales.find(lang =>
    path.startsWith(`/${lang}/`) || path === `/${lang}` || path === `/${lang}/`,
  )
  return secondaryLang || defaultLocale
}

const currentLang = getLangFromPath(currentPath)
const currentUI = ui[currentLang as keyof typeof ui]

function getLocalizedPath(path: string) {
  const clean = cleanPath(path)
  return currentLang === defaultLocale ? `/${clean}` : `/${currentLang}/${clean}`
}

function isHomePage(path: string) {
  const clean = cleanPath(path)
  return clean === '' || moreLocales.includes(clean)
}
function isPostPage(path: string) {
  const clean = cleanPath(path)
  return clean.startsWith('posts') || moreLocales.some(lang => clean.startsWith(`${lang}/posts`))
}
function isTagPage(path: string) {
  const clean = cleanPath(path)
  return clean.startsWith('tags') || moreLocales.some(lang => clean.startsWith(`${lang}/tags`))
}
function isAboutPage(path: string) {
  const clean = cleanPath(path)
  return clean.startsWith('about') || moreLocales.some(lang => clean.startsWith(`${lang}/about`))
}

const isPostActive = isHomePage(currentPath) || isPostPage(currentPath)
const isTagActive = isTagPage(currentPath)
const isAboutActive = isAboutPage(currentPath)

---

<nav class="mb-16 mt-13 text-5.6 font-semibold leading-13 font-navbar">
  <ul>
    <li>
      <a
        href={getLocalizedPath('/')}
        class:list={[
          isPostActive ? 'underline-animation font-bold text-primary' : 'underline-animation',
        ]}
      >
        {currentUI.posts}
      </a>
    </li>
    <li>
      <a
        href={getLocalizedPath('/tags')}
        class:list={[
          isTagActive ? 'underline-animation font-bold text-primary' : 'underline-animation',
        ]}
      >
        {currentUI.tags}
      </a>
    </li>
    <li>
      <a
        href={getLocalizedPath('/about')}
        class:list={[
          isAboutActive ? 'underline-animation font-bold text-primary' : 'underline-animation',
        ]}
      >
        {currentUI.about}
      </a>
    </li>
  </ul>
</nav>

<script is:inline>
document.addEventListener('astro:before-preparation', (event) => {
  const hoverElement = document.querySelector('.underline-animation:hover')

  if (hoverElement) {
    const originalLoader = event.loader

    event.loader = async function () {
      await new Promise((resolve) => {
        // 添加强制收回动画的类
        hoverElement.classList.add('force-leave')

        // 等待动画完成
        setTimeout(resolve, 300)
      })

      return originalLoader()
    }
  }
})

// 为所有带有下划线动画的链接添加点击事件处理
document.addEventListener('click', (e) => {
  const link = e.target.closest('.underline-animation')
  if (link) {
    link.classList.add('force-leave')
  }
})
</script>
