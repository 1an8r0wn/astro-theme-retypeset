<script>
// Initialize theme toggle button
const themeToggle = document.querySelector('button[aria-pressed]') as HTMLButtonElement
themeToggle.setAttribute('aria-pressed', String(document.documentElement.classList.contains('dark')))

// Core theme switching logic
function switchTheme() {
  document.body.removeAttribute('data-restore-theme')
  const isDark = document.documentElement.classList.toggle('dark')
  themeToggle.setAttribute('aria-pressed', String(isDark))
  localStorage.setItem('theme', isDark ? 'dark' : 'light')
  document.dispatchEvent(new Event('theme-changed'))
}

// Handle theme toggle with view transitions API
function toggleTheme() {
  if (!document.startViewTransition) {
    switchTheme()
    return
  }

  // Set transition name for theme toggle
  document.documentElement.style.setProperty('view-transition-name', 'theme-transition')

  // Execute transition
  const transition = document.startViewTransition(() => {
    switchTheme()
  })

  // Clean up after transition
  transition.finished.then(() => {
    document.documentElement.style.removeProperty('view-transition-name')
  })
}

// Sync theme state across page navigation
function syncTheme() {
  document.body.setAttribute('data-restore-theme', 'true')
  const theme = localStorage.getItem('theme')
  document.documentElement.classList.toggle('dark', theme === 'dark')
  themeToggle.setAttribute('aria-pressed', String(theme === 'dark'))
  requestAnimationFrame(() => {
    document.body.removeAttribute('data-restore-theme')
  })
}

// Event listeners
document.addEventListener('astro:page-load', () => {
  const themeToggle = document.querySelector('button[aria-pressed]') as HTMLButtonElement
  themeToggle.setAttribute('aria-pressed', String(document.documentElement.classList.contains('dark')))
  themeToggle.addEventListener('click', toggleTheme)
})

document.addEventListener('astro:after-swap', syncTheme)
window.addEventListener('popstate', syncTheme)
window.addEventListener('pageshow', (event) => {
  if (event.persisted) {
    syncTheme()
  }
})
</script>

<button
  aria-pressed="false"
  aria-label="Theme Toggle Button"
  class="absolute right-9.6 top-19.8 z-9 aspect-square w-7 c-secondary active:scale-92"
>
  <svg
    viewBox="0 0 24 24"
    xmlns="http://www.w3.org/2000/svg"
    fill="currentColor"
  >
    <path d="m12 1c-6.1 0-11 4.9-11 11s4.9 11 11 11 11-4.9 11-11-4.9-11-11-11m0 20c-5.8 0-10.5-4-10.5-9s4.7-9 10.5-9 10.5 4 10.5 9-4.7 9-10.5 9" />
  </svg>
</button>
